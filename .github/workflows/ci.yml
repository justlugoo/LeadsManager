# .github/workflows/ci.yml
name: CI/CD LeadsManager

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # Job 1: Verificar que el código compila y las imágenes se construyen
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4
    
    - name: 🔧 Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: 🏗️ Build backend image
      run: |
        cd backend-lm
        docker build -t leadsmanager-backend:test .
    
    - name: 🏗️ Build frontend image
      run: |
        cd frontend-lm  
        docker build -t leadsmanager-frontend:test .
    
    - name: ✅ Test Docker Compose
      run: |
        docker compose build
        docker compose up -d
        sleep 30
        # Verificar que los servicios respondan
        curl -f http://localhost:8000/ || exit 1
        curl -f http://localhost:3000/ || exit 1
        docker compose down

  # Job 2: Push de imágenes al registry (solo en push a main)
  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4
    
    - name: 🔧 Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: 🔑 Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: 🏷️ Generate image tags
      id: meta
      run: |
        echo "date=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
        echo "sha=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
    
    - name: 🚀 Build and push backend image
      run: |
        cd backend-lm
        docker build -t ghcr.io/${{ github.repository_owner }}/leadsmanager-backend:latest .
        docker build -t ghcr.io/${{ github.repository_owner }}/leadsmanager-backend:${{ steps.meta.outputs.sha }} .
        docker push ghcr.io/${{ github.repository_owner }}/leadsmanager-backend:latest
        docker push ghcr.io/${{ github.repository_owner }}/leadsmanager-backend:${{ steps.meta.outputs.sha }}
    
    - name: 🚀 Build and push frontend image
      run: |
        cd frontend-lm
        docker build -t ghcr.io/${{ github.repository_owner }}/leadsmanager-frontend:latest .
        docker build -t ghcr.io/${{ github.repository_owner }}/leadsmanager-frontend:${{ steps.meta.outputs.sha }} .
        docker push ghcr.io/${{ github.repository_owner }}/leadsmanager-frontend:latest
        docker push ghcr.io/${{ github.repository_owner }}/leadsmanager-frontend:${{ steps.meta.outputs.sha }}
    
    - name: 🎉 Deployment complete
      run: |
        echo "🎉 Images pushed successfully!"
        echo "Backend: ghcr.io/${{ github.repository_owner }}/leadsmanager-backend:${{ steps.meta.outputs.sha }}"
        echo "Frontend: ghcr.io/${{ github.repository_owner }}/leadsmanager-frontend:${{ steps.meta.outputs.sha }}"
